name: Build & Publish project

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  build:
    permissions:
      contents: write
    runs-on: windows-latest

    env:
      PROGRAM_VERSION: ${{ github.event.release.tag_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore cached Primes
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ github.workspace }}\build
          key: ${{ runner.os }}-build-cache-${{ hashFiles('CMakeLists.txt', 'vcpkg.json') }}

      - name: Verify tools
        run: |
          clang-cl --version
          cmake --version

      - name: Configure (Debug)
        run: >
          cmake
          -DCMAKE_BUILD_TYPE=Debug
          -DCMAKE_EXPORT_COMPILE_COMMANDS=TRUE
          -DCMAKE_C_COMPILER="C:\Program Files\LLVM\bin\clang-cl.exe"
          -DCMAKE_CXX_COMPILER="C:\Program Files\LLVM\bin\clang-cl.exe"
          -S "${{ github.workspace }}"
          -B "${{ github.workspace }}\build"
          -G "Ninja"

      - name: Build (Debug)
        run: >
          cmake
          --build "${{ github.workspace }}\build"
          --config Debug
          --target all

      - name: Configure (Release)
        run: >
          cmake
          -DCMAKE_BUILD_TYPE=Release
          -DCMAKE_EXPORT_COMPILE_COMMANDS=TRUE
          -DCMAKE_C_COMPILER="C:\Program Files\LLVM\bin\clang-cl.exe"
          -DCMAKE_CXX_COMPILER="C:\Program Files\LLVM\bin\clang-cl.exe"
          -S "${{ github.workspace }}"
          -B "${{ github.workspace }}\build"
          -G "Ninja"

      - name: Build (Release)
        run: >
          cmake
          --build "${{ github.workspace }}\build"
          --config Release
          --target all

      - name: Save Primes
        if: steps.cache-restore.outputs.cache-hit != 'true'
        id: cache-save
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ github.workspace }}\build
          key: ${{ runner.os }}-build-cache-${{ hashFiles('CMakeLists.txt', 'vcpkg.json') }}

      - name: Package builds
        if: github.event_name == 'release' && github.event.action == 'published'
        run: |
          7z a ImageViewer_debug-${{ github.event.release.tag_name }}.zip .\output\Debug\*
          7z a ImageViewer_release-${{ github.event.release.tag_name }}.zip .\output\Release\*

      - name: Conventional Changelog Action
        if: github.event_name == 'release' && github.event.action == 'published'
        id: changelog
        uses: TriPSs/conventional-changelog-action@v5
        with:
          github-token: ${{ secrets.github_token }}
          skip-commit: "true"
          output-file: "false"

      - name: Publish GitHub Release
        if: ${{ steps.changelog.outputs.skipped == 'false' }} && github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          name: "ImageViewer ${{ github.event.release.tag_name }}"
          body: ${{ steps.changelog.outputs.clean_changelog }}
          files: |
            ImageViewer_release-${{ github.event.release.tag_name }}.zip
            ImageViewer_debug-${{ github.event.release.tag_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}